/**
 * @author: gaohui
 * @date: 2017-03-02
 * @last modified by: gaohui
 * @last modified time: 2017-04-13 20:23:33
 * @file:查看任务
 */
var roleNum = lsObj.getLocalStorage("params"); //获取角色 的标识
var objectId = getParameter("eventId"); //获取任务id

var map = new BMap.Map("task_map"); //创建一个地图实例
// var echartData = new object();
var $mapBtn = $(".bottom_btn span");
var $mapO = $("#task_map"); //百度地图DIV容器
var detectMethod = getParameter('detectMethod') //检测方法
var detectUserId = getParameter('detectUserId') //检测检测人员ID
var taskStatus = decodeURI(getParameter('taskStatus')) //任务状态
var token = lsObj.getLocalStorage('token');
var Option3;
var Option2;
var Option1;

$(function() {
    getTaskInfo() //渲染任务页面
        // if (roleNum == 2) {
        //     $('#rejected').css('display', 'none')
        //     $('#taskProgressStyle').css('display', '') //任务进度布局
        //     $('#lineStyle').css('display', '')
        //     $('#peopleStatisticsStyle').css('display', '') //人员统计布局
        //     $('#recorderStyle').css('display', '') //人员统计布局
        //     initPeopleStatistics()
        //         getTaskProcess()

    // } else {
    //     $('#taskStaticStyle').css('display', '') //人员统计布局
    // if (taskStatus == '待领取' || taskStatus == '已审核') {
    //     $('#rejected').css('display', 'none')
    // }
    // }
    if (roleNum == 2) {
        setTimeout(function() {
            initPeopleStatistics();
            getTaskProcess()
        }, 100)

    }
    $mapO.slideUp();
    $mapBtn.attr("class", "map_down");
    // 初始化地图
    initMap();
    //1.初始化Table
    // var oTable = new TableInit();
    if (detectMethod == 1) {
        $("#analysisResultM1").css("display", "inherit")
        $.getScript("../../../js/task/specific_task/graph_m1.js");
        $('#graph_2').css('display', 'none')
        M1();
    } else if (detectMethod == 2) {
        $("#analysisResultM2").css("display", "inherit")
        $.getScript("../../../js/task/specific_task/graph_m2.js");
        M2()
    } else if (detectMethod == 3 || detectMethod == 6) {
        $("#analysisResultM3").css("display", "inherit")
        $.getScript("../../../js/task/specific_task/graph_m3_m6.js");
        $('#graph_2').css('display', 'none')
        M3();

    } else if (detectMethod == 4) {
        $("#analysisResultM4").css('display', "inherit");
        $('#curve').css('display', 'none')
        M4();
    } else if (detectMethod == 5) {
        $("#analysisResultM5").css("display", "inherit")
        $('#curve').css('display', 'none')
        M5();
    } else if (detectMethod == 7) {
        $("#analysisResultM7").css("display", "inherit")
        $('#curve').css('display', 'none')
        M7();
    } else if (detectMethod == 8) {
        $("#analysisResultM8").css("display", "inherit")
        $('#curve').css('display', 'none')
        M8();
    } else if (detectMethod == 9) {
        $("#analysisResultM9").css("display", "inherit")
        $('#curve').css('display', 'none')
        M9();
    } else if (detectMethod == 10) {
        $("#analysisResultM10").css("display", "inherit")
        $('#curve').css('display', 'none')
        M10();
    }
    queryPipeData(); //初始化下拉选（所属管线））；
    $("#pipeName1").bind("change", function() {
        var pipeNameID = $("#pipeName1").val();
        if (pipeNameID != null) {
            queryMarkData(pipeNameID);
        }
    });
});


//初始化下拉选（所属管线））；
function queryPipeData() {
    $.ajax({
        url: "/cloudlink-corrosionengineer/task/queryPipeCheck?taskId=" + objectId,
        dataType: "json",
        method: "get",
        success: function(result) {
            if (result.success == 1) {
                var data = result.rows;
                var options = "<option value=''>请选择</option>";
                for (var i = 0; i < data.length; i++) {
                    options += "<option value='" + data[i].id + "'>" + data[i].text + "</option>"
                }
                var myobj = document.getElementById('pipeName1');
                if (myobj.options.length == 0) {
                    $("#pipeName1").html(options);
                    // $('#pipeName').selectpicker('refresh');
                }
            } else {
                layer.msg("加载下拉选失败");
            }
        }
    });
}

//加载下拉测试桩号下拉桩的值
function queryMarkData(pipelineId) {
    $.ajax({
        url: "/cloudlink-corrosionengineer/task/queryMarkCheck?flag=check&pipelineId=" + pipelineId+'&token='+token,
        dataType: "json",
        type: "get",
        async: false,
        success: function(result) {
            if (result.success == 1) {
                var data = result.rows;
                var options = "<option value=''>请选择</option>";
                for (var i = 0; i < data.length; i++) {
                    options += "<option value='" + data[i].id + "'>" + data[i].text + "</option>"
                }
                $("#pipeendNumberName1").html(options);
                $("#pipestartNumberName1").html(options);
            }
        },

    });
}

var jsonExportWord = { "pipelineId": "", "detectResult": "", "startMarkNum": "", "endMarkNum": "", "detectStatus": "", "recorder": "" } //定义一个全局的json数组
    //查询测试桩数据
function querylistData() {
    if (roleNum == 2) {
        jsonExportWord.recorder = $('#recorder').val()
    }
    jsonExportWord.pipelineId = $("#pipeName1").val();
    jsonExportWord.detectResult = chk();
    jsonExportWord.detectStatus = $('#detectStatus').val()
    jsonExportWord.startMarkNum = $("#pipestartNumberName1").val();

    if ($("#pipeendNumberName1").val() != undefined && $("#pipeendNumberName1").val() != null && $("#pipeendNumberName1").val() != "null") {
        jsonExportWord.endMarkNum = $("#pipeendNumberName1").val();
    }
    if (jsonExportWord.endMarkNum - 0 < jsonExportWord.startMarkNum - 0) {
        parent.layer.confirm("起始桩号不能大于终止桩号", {
            btn: ['确定'], //按钮
            skin: 'self'
        });
        return;
    }
    $("#tb-all-task").bootstrapTable('refreshOptions', {pageNumber:1});

}

//重置方法
function clearSearchData() {
    document.getElementById("searchMarker").reset();
    querylistData();
}

//获取复选框参数
function chk() {
    var obj = document.getElementsByName('analysisResult'); //选择所有name="'test'"的对象，返回数组 
    //取到对象数组后，我们来循环检测它是不是被选中 
    var analysisResult = "";
    for (var i = 0; i < obj.length; i++) {
        if (obj[i].checked) {
            analysisResult += obj[i].value + ','; //如果选中，将value添加到变量s中 
        }
    }
    analysisResult = analysisResult.substring(0, analysisResult.length - 1);
    return analysisResult;
}

//任务m5网格化
function M5() {
    $('#tb-all-task').bootstrapTable({
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        pageSize: 5,
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        toolbar: '#toolbar',
        columns: [
            [{
                checkbox: true,
                rowspan: 2
            }, {
                field: 'objectId',
                title: 'objectId',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_x',
                title: 'map_x',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_y',
                title: 'map_y',
                rowspan: 2,
                visible: false
            }, {
                field: 'sequence',
                title: '序号',
                rowspan: 2
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                rowspan: 2
            }, {
                title: '自己恒电位仪开启',
                rowspan: 1,
                colspan: 2
            }, {
                title: '自己恒电位仪关闭',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                title: '外部恒电位仪开启',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                title: '外部恒电位仪关闭',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                field: 'offPotentialOfAvg',
                title: '自己管道试片断电电位(mv)',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'soilResistivity',
                title: '土壤电阻率，Ω.m',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'createUserName',
                title: '记录人',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: '',
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var res = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' +
                        row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open" ></span></a>';
                    return res;
                }
            }],
            [{
                field: 'plPotentialRecitifierOn',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialRecitifierOn',
                title: '外部管道电位（mv）',
                align: 'center'
            }, {
                field: 'plPotentialRecitifierOff',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialRecitifierOff',
                title: '外部管道电位（mv）',
                align: 'center'
            }, {
                field: 'plPotentialForRecitifierOn',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialForRecitifierOn',
                title: '外部管道电位（mv）',
                align: 'center'
            }, {
                field: 'plPotentialForRecitifierOff',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialForRecitifierOff',
                title: '外部管道电位（mv）',
                align: 'center'
            }]
        ],
        onDblClickRow: function(row) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {

            if (res.rows.length == 0) {
                $('#graph').css('display', 'none')
            }
        }

    });
}

//任务m7网格化
function M7() {
    $('#tb-all-task').bootstrapTable({
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        // sidePagination: "server", // 服务端请求
        pageSize: 5,
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        // clickToSelect: true,
        toolbar: '#toolbar',
        columns: [
            [{
                checkbox: true,
                valign: "middle",
                rowspan: 2
            }, {
                field: 'objectId',
                title: 'objectId',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_x',
                title: 'map_x',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_y',
                title: 'map_y',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'sequence',
                title: '序号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                title: '自己恒电位仪开启',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                title: '自己恒电位仪关闭',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                title: '外部恒电位仪开启',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                title: '外部恒电位仪关闭',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 2
            }, {
                field: 'offPotentialOfAvg',
                title: '自己管道试片断电电位(mv)',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'soilResistivity',
                title: '土壤电阻率，Ω.m',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'createUserName',
                title: '记录人',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: '',
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var res = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' +
                        row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open" ></span></a>';
                    return res;
                }
            }],
            [{
                field: 'plPotentialRecitifierOn',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialRecitifierOn',
                title: '外部管道电位（mv）',
                align: 'center'
            }, {
                field: 'plPotentialRecitifierOff',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialRecitifierOff',
                title: '外部管道电位（mv）',
                align: 'center'
            }, {
                field: 'plPotentialForRecitifierOn',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialForRecitifierOn',
                title: '外部管道电位（mv）',
                align: 'center'
            }, {
                field: 'plPotentialForRecitifierOff',
                title: '自己管道电位（mv）',
                align: 'center'
            }, {
                field: 'forPlPotentialForRecitifierOff',
                title: '外部管道电位（mv）',
                align: 'center'
            }]
        ],
        onDblClickRow: function(row) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {
            // if(res.success == 1){

            if (res.rows.length == 0) {
                $('#graph').css('display', 'none')
            }
            // }
        }

    });
}

//任务m1网格化
function M1() {
    Option1 = {
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        toolbar: '#toolbar',
        pageSize: 5,
        sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        // pageList: [5, 20, 50],
        // clickToSelect: true,
        columns: [
            [{
                checkbox: true,
                valign: "middle",
                rowspan: 2,
            }, {
                field: 'objectId',
                title: 'objectId',
                align: 'center',
                visible: false,
                rowspan: 2,
            }, {
                field: 'map_x',
                title: 'map_x',
                align: 'center',
                visible: false,
                rowspan: 2
            }, {
                field: 'map_y',
                title: 'map_y',
                align: 'center',
                visible: false,
                rowspan: 2
            }, {
                field: 'sequence',
                title: '序号',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: 'detectStatus',
                title: '检测状态',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: 'onPotentialOfAvg',
                title: '通电电位(mV)',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 3
            }, {
                field: 'avOfPlAvg',
                title: '交流电压(V)',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 3
            }, {
                field: 'analysisResult',
                title: '分析结果',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    if (row.analysisResult == 1) {
                        return;
                    } else if (row.analysisResult == 2) {
                        var res = "<img class='dc-style' src = '/src/images/task/dc.png'>";
                        return res;
                    } else if (row.analysisResult == 3) {
                        var res = "<img class='ac-style' src = '/src/images/task/ac.png'>";
                        return res;
                    } else if (row.analysisResult == 4) {
                        var res = "<img class='dc-style' src = '/src/images/task/dc.png' style='padding-right: 5%'>";
                        res += "<img class='ac-style' src = '/src/images/task/ac.png'>";
                        return res;
                    }

                }
            }, {
                field: 'markerStaus',
                title: '桩状况',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'createUserName',
                title: '记录人',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: '',
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var res = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' +
                        row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open" ></span></a>';
                    return res;
                }
            }],
            [{
                field: 'onPotentialOfMax',
                title: '最大值',
                align: 'center'
            }, {
                field: 'onPotentialOfMin',
                title: '最小值',
                align: 'center'
            }, {
                field: 'onPotentialOfAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'avOfPlMax',
                title: '最大值',
                align: 'center'
            }, {
                field: 'avOfPlMin',
                title: '最小值',
                align: 'center'
            }, {
                field: 'avOfPlAvg',
                title: '平均值',
                align: 'center'
            }]
        ],
        onDblClickRow: function(row) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {
            /**
             * var flag = JSON.stringify(res.rows).indexOf('已检测')!= -1 || JSON.stringify(res.rows).indexOf('无法检测')!= -1
                if (!flag) {
                    $('#graph').css('display', 'none')
                } else {
                    $('#graph').css('display', '')
                }
            */
        },
        onCheck:function(res){
            // console.log(res.markerId)
            // console.log(optionM1.xAxis[1].data)
            var markerId = res.markerId;    //获取当前点击的markerId
            var data_x = optionM1.xAxis[1].data;    //获取曲线图中所有markerId的数组
            var num ="";
            
            for(var i = 0 ;i < data_x.length;i++){
                if(markerId == data_x[i]){
                    num = i;
                    break;
                }
            }
            if(num.length == 0){
               return
            }
             var n = num - 10 < 0 ? 0:num-10;
            // if(num < 49){
                optionM1.dataZoom[0].startValue = n
                optionM1.dataZoom[0].endValue = n+49
                optionM1.animation = false;
                myChartM1.setOption(optionM1); 
            // }
            myChartM1.dispatchAction({
                type: 'showTip', //action的类型,
                dataIndex: num,                 
            })
        }
    }
    $('#tb-all-task').bootstrapTable(Option1);
}

//任务m3网格化
function M3() {
    Option3 = {
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        pageSize: 5,
        // clickToSelect: true,
        // pageList: [5, 20, 50],
        // sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        toolbar: '#toolbar',
        columns: [
            [{
                checkbox: true,
                valign: "middle",
                rowspan: 2
            }, {
                field: 'objectId',
                title: 'objectId',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_x',
                title: 'map_x',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_y',
                title: 'map_y',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'sequence',
                title: '序号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'detectStatus',
                title: '检测状态',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                title: '试片通电电位(mV)',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 1
            }, {
                title: '试片断电电位(mV)',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 1
            }, {
                title: '阴保电流密度(A/m²)',
                valign: "middle",
                align: 'center',
                rowspan: 1,
                colspan: 1
            }, {
                field: 'soilResistivity',
                title: '土壤电阻率(Ω.m)',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'analysisResultVal',
                title: '分析结果',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'pipelineName',
                title: '所属管线',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'createTime',
                title: '检测时间',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'createUserName',
                title: '检测人',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'operation',
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var e = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' + row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open"></span></a> ';
                    return e;
                }
            }],
            [{
                field: 'onPotentialOfCouponAvg',
                title: '平均值',
                align: 'center'
            }, {

                field: 'offPotentialOfCouponAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'cpCurrentDensityAvg',
                title: '平均值',
                align: 'center'
            }]
        ],
        onDblClickRow: function(row) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {
           /**
            *   
                var flag = JSON.stringify(res.rows).indexOf('已检测')!= -1 || JSON.stringify(res.rows).indexOf('无法检测')!= -1
                if (!flag) {
                    $('#graph').css('display', 'none')
                } else {
                    $('#graph').css('display', '')
                }
           */
        },
         onCheck:function(res){
            // console.log(res.markerId)
            // console.log(optionM1.xAxis[1].data)
            var markerId = res.markerId;    //获取当前点击的markerId
            var data_x = option.xAxis[1].data;    //获取曲线图中所有markerId的数组
            var num ="";
            
            for(var i = 0 ;i < data_x.length;i++){
                if(markerId == data_x[i]){
                    num = i;
                    break;
                }
            }
            if(num.length == 0){
               return
            }
            var n = num - 10 < 0 ? 0:num-10;
            option.dataZoom[0].startValue = n
            option.dataZoom[0].endValue = n+49
            option.animation = false;
            myChart1.setOption(option); 
            myChart1.dispatchAction({
                type: 'showTip', //action的类型,
                dataIndex: num,                
            })
        }
    };
    $('#tb-all-task').bootstrapTable(Option3);
};

//任务m2网格化
function M2(){
    Option2 = {
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        pageSize: 5,
        // clickToSelect: true,
        // sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        toolbar: '#toolbar',
        columns: [
            [{
                checkbox: true,
                valign: "middle",
                rowspan: 2,
            }, {
                field: 'objectId',
                title: 'objectId',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_x',
                title: 'map_x',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'map_y',
                title: 'map_y',
                align: 'center',
                rowspan: 2,
                visible: false
            }, {
                field: 'sequence',
                title: '序号',
                valign: "middle",
                rowspan: 2,
                align: 'center',
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                valign: "middle",
                rowspan: 2,
                align: 'center',
            }, {
                field: 'detectStatus',
                title: '检测状态',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                title: '交流电压(V)',
                valign: "middle",
                align: 'center',

                colspan: 1
            }, {
                title: '试片通电电位(mV)',
                valign: "middle",
                align: 'center',

                colspan: 1
            }, {

                title: '试片断电电位(mV)',
                valign: "middle",
                align: 'center',

                colspan: 1
            }, {
                title: '交流电流密度(A/m²)',
                valign: "middle",
                align: 'center',
                colspan: 1
            }, {

                title: '直流电流密度(A/m²)',
                valign: "middle",
                align: 'center',

                colspan: 1
            }, {
                field: 'ratioOfCouponDcAc',
                title: '交直流电流密度比',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: 'soilResistivity',
                title: '土壤电阻率(Ω.m)',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: 'analysisResultVal',
                title: '分析结果',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: 'createUserName',
                title: '记录人',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                field: '',
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var res = "<i class='glyphicon glyphicon-eye-open' onclick=\"showData('" + row.objectId + "')\"></i></a>";
                    return res;
                }
            }],
            [{
                field: 'avOfPlAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'onPotentialOfCouponAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'offPotentialOfCouponAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'couponAcDensityAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'couponDcDensityAvg',
                title: '平均值',
                align: 'center'
            }]
        ],
        onDblClickRow: function(row) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {
            // var flag = JSON.stringify(res.rows).indexOf('已检测')!= -1 || JSON.stringify(res.rows).indexOf('无法检测')!= -1
            // if (!flag) {
            //         $('#graph').css('display', 'none')
            //     } else {
            //         $('#graph').css('display', '')
            // }
        },
         onCheck:function(res){ //点击检测数据实现选中折线图
            // console.log(res.markerId)
            // console.log(optionM1.xAxis[1].data)
            var markerId = res.markerId;    //获取当前点击的markerId
            var data_x = option.xAxis[1].data;    //获取曲线图中所有markerId的数组
            var num ="";
            
            for(var i = 0 ;i < data_x.length;i++){
                if(markerId == data_x[i]){
                    num = i;
                    break;
                }
            }
            if(num.length == 0){
               return
            }
             var n = num - 10 < 0 ? 0:num-10;
            option.dataZoom[0].startValue = n
            option.dataZoom[0].endValue = n+49
            option.animation = false;
            myChart1.setOption(option); 

            option2.dataZoom[0].startValue = n
            option2.dataZoom[0].endValue = n+49
            option2.animation = false;
            myChart2.setOption(option2); 

            myChart1.dispatchAction({
                type: 'showTip', //action的类型,
                dataIndex: num,                
            })
            myChart2.dispatchAction({
                type: 'showTip', //action的类型,
                dataIndex: num,                
            })
        }
            

    }
    $('#tb-all-task').bootstrapTable(Option2);
    

};

//任务m4网格化
function M4() {
    $('#tb-all-task').bootstrapTable({
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        pageSize: 5,
        // clickToSelect: true,
        // sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        toolbar: '#toolbar',
        columns: [
            [{
                    checkbox: true,
                    valign: "middle",
                    rowspan: 2
                }, {
                    field: 'objectId',
                    title: 'objectId',
                    align: 'center',
                    rowspan: 2,
                    visible: false
                }, {
                    field: 'map_x',
                    title: 'map_x',
                    align: 'center',
                    rowspan: 2,
                    visible: false
                }, {
                    field: 'map_y',
                    title: 'map_y',
                    align: 'center',
                    rowspan: 2,
                    visible: false
                }, {
                    field: 'sequence',
                    title: '序号',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'markerNumber',
                    title: '测试桩号',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'detectStatus',
                    title: '检测状态',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2,
                }, {
                    title: '管道通电电位(mV)',
                    valign: "middle",
                    align: 'center',
                    rowspan: 1,
                    colspan: 1
                }, {
                    title: '管道断电电位(mV)',
                    valign: "middle",
                    align: 'center',
                    rowspan: 1,
                    colspan: 1
                }, {
                    field: 'onPoteniallOfCasing',
                    title: '套管通电电位(mV)',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'offPotenialOfCasing',
                    title: '套管断电电位(mV)',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                },
                {
                    field: 'analysisResultVal',
                    title: '分析结果',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'pipelineName',
                    title: '所属管线',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'createTime',
                    title: '检测时间',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'createUserName',
                    title: '检测人',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2
                }, {
                    field: 'operation',
                    title: '操作',
                    valign: "middle",
                    align: 'center',
                    rowspan: 2,
                    formatter: function(value, row, index) {
                        var e = '<a href="#" mce_href="#" onclick="showData(\'' + row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open"></span></a> ';
                        return e;
                    }
                }
            ],
            [{
                field: 'onPotentialOfAvg',
                title: '平均值',
                align: 'center'
            }, {
                field: 'offPotentialOfAvg',
                title: '平均值',
                align: 'center'
            }]
        ],
        onDblClickRow: function(row) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {}
    });
};

//任务m8网格化
function M8() {
    $('#tb-all-task').bootstrapTable({
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        pageSize: 5,
        // sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        // clickToSelect: true,
        toolbar: '#toolbar',
        columns: [{
            checkbox: true,
            valign: "middle"
        }, {
            field: 'objectId',
            title: 'objectId',
            align: 'center',
            visible: false
        }, {
            field: 'sequence',
            title: '序号',
            valign: "middle",
            align: 'center'
        }, {
            field: 'markerNumber',
            title: '测试桩号',
            valign: "middle",
            align: 'center'
        }, {
            field: 'detectStatus',
            title: '检测状态',
            valign: "middle",
            align: 'center',
        }, {
            field: 'onPotentialOfAvg',
            title: '保护端管道电位（V）',
            valign: "middle",
            align: 'center'
        }, {
            field: 'avOfPlAvg',
            title: '保护端管道交流电压（V）',
            valign: "middle",
            align: 'center'
        }, {
            field: 'couponOfPlNonProtectSide',
            title: '非保护端管道电位（V）',
            valign: "middle",
            align: 'center'
        }, {
            field: 'avOfPlNonProtectSide',
            title: '非保护端管道交流电压（V）',
            valign: "middle",
            align: 'center'
        }, {
            field: 'crossoverCurrent',
            title: '跨接电流（A）',
            valign: "middle",
            align: 'center'
        }, {
            field: 'pipelineName',
            title: '所属管线',
            valign: "middle",
            align: 'center'
        }, {
            field: 'createTime',
            title: '检测时间',
            valign: 'middle',
            align: 'center'
        }, {
            field: 'createUserName',
            title: '记录人',
            valign: "middle",
            align: 'center'
        }, {
            field: 'option',
            title: '操作',
            valign: "middle",
            align: 'center',
            formatter: function(value, row, index) {
                var e = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' +
                    row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open" ></span></a>';
                return e;
            }
        }],
        onDblClickRow: function(row, field) {
            showData(row.objectId,row.detectStatus);
        },
        onLoadSuccess: function(res) {}
    });
};

//任务m9网格化
function M9() {
    $('#tb-all-task').bootstrapTable({
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        pageSize: 5,
        // sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        // clickToSelect: true,
        toolbar: '#toolbar',
        columns: [
            [{
                checkbox: true,
                valign: "middle",
                rowspan: 2
            }, {
                field: 'objectId',
                title: 'objectId',
                align: 'center',
                visible: false,
                rowspan: 2
            }, {
                field: 'sequence',
                title: '序号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'detectStatus',
                title: '检测状态',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                title: '输出电流（A）',
                valign: 'middle',
                align: 'center',
                colspan: 1
            }, {
                title: '输出电压（V）',
                valign: 'middle',
                align: 'center'
            }, {
                field: 'cpLoopResistance',
                title: '回路电阻（Ω）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'setupPotentialOfRecitifier',
                title: '设定电位（mV）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'setupOffPotentialOfRecitifier',
                title: '设定断电电位（mV）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'onPotentialOnPipeConnectionAvg',
                title: '汇流点通电电位（mV）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'offPotentialOnPipeConnectionAvg',
                title: '汇流点断电电位（mV）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'onPotentialOnAnodeAvg',
                title: '阳极地床平均通电电位（mV）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'offPotentialOnAnodeAvg',
                title: '阳极地床平均断电电位（mV）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'apparentResistanceOfPl',
                title: '管道视电阻（Ω）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'apparentResistanceOfGroundbed',
                title: '地床视电阻（Ω）',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'pipelineName',
                title: '所属管线',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'createTime',
                title: '检测时间',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'createUserName',
                title: '记录人',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var e = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' +
                        row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open" ></span></a>';
                    return e;
                }
            }],
            [{
                field: 'outputCurrentOfRecitifierAvg',
                title: '平均值',
                valign: "middle",
                align: 'center'
            }, {
                field: 'outputVoltageOfRecitifierAvg',
                title: '平均值',
                valign: "middle",
                align: 'center'
            }]
        ],
        onDblClickRow: function(row, field) {
            showData(row.objectId,row.detectStatus);
        },
    });
};

//任务m10网格化
function M10() {
    $('#tb-all-task').bootstrapTable({
        url: handleURL("/cloudlink-corrosionengineer/task/queryDetectionPage?taskId=" + objectId),
        method: 'get', //请求方式（*）
        // striped: true, //使表格带有条纹
        // pagination: true, //在表格底部显示分页工具栏
        pageSize: 5,
        sidePagination: "server", // 服务端请求
        queryParams: queryParams,
        responseHandler: responseHandler,
        queryParamsType: "size",
        // clickToSelect: true,
        toolbar: '#toolbar',
        columns: [
            [{
                checkbox: true,
                valign: "middle",
                rowspan: 2
            }, {
                field: 'objectId',
                title: 'objectId',
                align: 'center',
                visible: false,
                rowspan: 2
            }, {
                field: 'sequence',
                title: '序号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'markerNumber',
                title: '测试桩号',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'detectStatus',
                title: '检测状态',
                valign: "middle",
                align: 'center',
                rowspan: 2,
            }, {
                title: '管道电位检测',
                valigin: "middle",
                align: 'center',
                colspan: 2,
            }, {
                title: '排流地床（牺牲阳极）性能',
                valigin: 'middle',
                align: 'center',
                colspan: 4
            }, {
                title: '牺牲阳极属性',
                valigin: 'middle',
                align: 'center',
                colspan: 3
            }, {
                field: 'pipelineName',
                title: '所属管线',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                field: 'createTime',
                title: '检测时间',
                valign: 'middle',
                align: 'center',
                rowspan: 2
            }, {
                field: 'createUserName',
                title: '记录人',
                valign: "middle",
                align: 'center',
                rowspan: 2
            }, {
                title: '操作',
                valign: "middle",
                align: 'center',
                rowspan: 2,
                formatter: function(value, row, index) {
                    var e = '<a href="#" mce_href="#" title="查看" onclick="showData(\'' +
                        row.objectId + '\',\''+row.detectStatus+'\')"><span class="glyphicon glyphicon-eye-open" ></span></a>';
                    return e;
                }
            }],
            [{
                field: 'plOnPotentialAnodeConnected',
                title: '通电电位（mV）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'plOffPotentialAnodeDisconnected',
                title: '断电电位（mV）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'potentialOfAnodeDisconnected',
                title: '开路电位（mV）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'currentFromPlToAnode',
                title: '输出电流（mA）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'currentFromPlToAnodeAfterConn',
                title: '连上10cm<sup>2</sup>试片输出电流（mA）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'anodeGroundResistance',
                title: '接地电阻（Ω）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'anodeWeight',
                title: '重量（kg）',
                valign: "middle",
                align: 'center',
            }, {
                field: 'anodeInstalationDate',
                title: '安装日期',
                valign: "middle",
                align: 'center',
            }, {
                field: 'anodeMaterial',
                title: '材料',
                valign: "middle",
                align: 'center',
            }]
        ],
        onDblClickRow: function(row, field) {
            showData(row.objectId,row.detectStatus);
            // var data = [];
            // data.push(row);
            // locationBmap(data);
        },
        onLoadSuccess: function(res) {

        }
    });
};

// 设置传入参数
function queryParams(params) {
    var recorder = ""
    if (roleNum == 2) {
        recorder = $('#recorder').val()
    }
    var temp = {
        pageSize: params.pageSize, //页面大小
        pageNum: this.pageNumber, //当前页码
        pipelineId: $("#pipeName1").val(),
        detectResult: chk(),
        detectMethod: detectMethod,
        startMarkNum: $("#pipestartNumberName1").val(),
        endMarkNum: $("#pipeendNumberName1").val(),
        recorder: recorder,
        detectStatus: $('#detectStatus').val(),
        token: token
    }
    return temp;
}

//设置边框底部页码
function responseHandler(res) {
    if (res.success == 1) {
        try {
            if (zhugeSwitch == 1) {
                zhuge.track('查询检测数据', { '任务类型': 'M' + detectMethod, "结果": "成功" });
            }
        } catch (error) {

        }
        var data = res.rows;
        return {
            "rows": res.rows,
            "total": res.totalElements
        }
    } else {
        try {
            if (zhugeSwitch == 1) {
                zhuge.track('查询检测数据', { '任务类型': 'M' + detectMethod, "结果": "失败" });
            }
        } catch (error) {

        }
         layer.msg("加载数据出错", {
            skin: "self-success"
        });
        return {
            "rows": [],
            "total": 0
        }
    }
}
//渲染页面
function getTaskInfo() {
    $.ajax({
        url: "/cloudlink-corrosionengineer/task/queryTaskInfo?objectId=" + objectId,
        method: 'get', //请求方式（*）
        success: function(result) {
            if (result.success == 1) {
                try {
                    if (zhugeSwitch == 1) {
                        zhuge.track('查看任务', { '任务类型': 'M' + detectMethod, "结果": "成功" });
                    }
                } catch (error) {

                }
                data = result.rows;
                if (data != null) {

                    var taskInfo = data.taskinfo;

                    // var detectdata = data.detectdata;
                    var taskFinishInfo = data.taskFinishInfo;
                    $('#taskName1').html(taskInfo.taskName); //任务名称
                    $('#detectMethod1').html('M' + taskInfo.detectMethod); //检测方法
                    $('#startTimePlan').html(taskInfo.startTimePlan); //计划结束时间
                    $('#endTimePlan').html(taskInfo.endTimePlan); //计划开始时间
                    $('#startTime').html(taskInfo.startTime);
                    $('#endTime').html(taskInfo.endTime);
                    $('#createTime').html((taskInfo.createTime));
                    $('#closeTime').html((taskInfo.closeTime));
                    $('#taskStatus').html((taskInfo.taskStatus));
                    // if(taskInfo.detectUserName != null){
                    //   detectUserName =  $.trim(taskInfo.detectUserName)
                    //   $('#detectUserName').html(detectUserName); //检测人员
                    // }
                    $('#detectUserName').html($.trim(taskInfo.detectUserName)); //检测人员
                    $('#detectUserName1').attr("title", $.trim(taskInfo.detectUserName));
                    $('#pipelineName').html(taskInfo.pipelineName); //所属管线
                    $('#createUserName').html(taskInfo.createUserName); //任务创建人
                    // var markerlist = ""
                    // if(data.markerlist.length > 0){
                    //     for(var i=0;i<data.markerlist.length;i++){
                    //         markerlist +="," + data.markerlist[i].marker_number;
                    //     }
                    // }
                    // $('#markerList').html(markerlist.slice(1))
                    var num = parseInt(((taskFinishInfo.taskSum - taskFinishInfo.TaskUnfinish) / taskFinishInfo.taskSum) * 10000 / 100.00) + "%"
                    $('#num').html(num)
                    initTaskStatic(taskFinishInfo);
                    // initPeopleStatistics(taskFinishInfo)
                    // getTaskProcess()

                }
            } else {
                try {
                    if (zhugeSwitch == 1) {
                        zhuge.track('查看任务', { '任务类型': 'M' + detectMethod, "结果": "失败" });
                    }
                } catch (error) {

                }
            }
        }

    })

}
//渲染任务统计柱状图
function initTaskStatic(taskFinishInfo) {
    var x;
    if (taskFinishInfo.taskSum < 4) {
        x = 4;
    } else {
        x = taskFinishInfo.taskSum + 1
    }
    // 基于准备好的dom，初始化echarts实例
    if (roleNum == 2) {
        var myChart = echarts.init(document.getElementById('taskProgress'));
    } else {
        var myChart = echarts.init(document.getElementById('taskStatic'));
    }
    // 指定图表的配置项和数据
    var option = {
        grid: {
            left: '3%',
            right: '4%',
            top: 0,
            bottom: '3%',
            containLabel: true
        },

        xAxis: {
            type: 'value',
            boundaryGap: [0, 0.01],
            minInterval: 1,
            max: x

        },
        yAxis: {
            type: 'category',
            data: ['驳回重测:' + taskFinishInfo.repeatDetect, '无法检测:' + taskFinishInfo.unDetect, '新增:0', '已检测:' + taskFinishInfo.taskDone, '待检测:' + taskFinishInfo.TaskUnfinish, '全部:' + taskFinishInfo.taskSum]
        },
        series: [{
            name: '2011年',
            type: 'bar',
            barWidth: 8,
            itemStyle: {
                normal: {
                    color: "#59b6fc",
                    barBorderRadius: 5
                },
            },
            data: [taskFinishInfo.repeatDetect, taskFinishInfo.unDetect, '0', taskFinishInfo.taskDone, taskFinishInfo.TaskUnfinish, taskFinishInfo.taskSum, ]
        }, ]
    };

    // 使用刚指定的配置项和数据显示图表。  
    myChart.setOption(option);
    window.onresize = myChart.resize;
}

// //任务进度
// function initTaskProgress(taskFinishInfo){
//     var taskProgressChar = echarts.init(document.getElementById('taskProgress'));
//     var option = {
//         title : {

//             x:'center'
//         },
//         tooltip : {
//             trigger: 'item',
//             formatter: "{a} <br/>{b} : {c} ({d}%)"
//         },
//         legend: {
//             orient: 'vertical',
//             left: 'left'
//         },
//         series : [
//             {
//                 name: '访问来源',
//                 type: 'pie',
//                 radius : '55%',
//                 center: ['50%', '60%'],
//                 data:[
//                     {value:taskFinishInfo.taskDone, name:'已完成'},
//                     {value:taskFinishInfo.unDetect, name:'无法检测'},
//                     {value:taskFinishInfo.TaskUnfinish, name:'待测试'}

//                 ],
//                 itemStyle: {
//                     emphasis: {
//                         shadowBlur: 10,
//                         shadowOffsetX: 0,
//                         shadowColor: 'rgba(0, 0, 0, 0.5)'
//                     }
//                 }
//             }
//         ]
//     };
//     taskProgressChar.setOption(option)
//     window.onresize = taskProgressChar.resize;
// }

var optionStatisticsChart = {}
var people = [];
var thisDay = [];
var thisWeek = [];
var thisMouth = [];

function getTaskProcess() {
    $.ajax({
        url: handleURL("/cloudlink-corrosionengineer/task/getTaskProcess?token=" + token + "&task=" + detectMethod + "&taskChose=" + objectId),
        method: 'get', //请求方式（*）
        success: function(result) {
            if (result.success == 1) {

                for (var key in result.rows.createUserCount) {
                    people.push(key)

                    thisDay.push(result.rows.createUserCount[key][0])
                    thisWeek.push(result.rows.createUserCount[key][1])
                    thisMouth.push(result.rows.createUserCount[key][2])
                }
              $('#peopleStatistics').width();
                optionStatisticsChart.xAxis[0].data = people
                optionStatisticsChart.series[0].data = thisDay;
                optionStatisticsChart.series[1].data = thisWeek;
                optionStatisticsChart.series[2].data = thisMouth;
                $('#num1').html(people.length);
                peopleStatisticsChart.setOption(optionStatisticsChart, true);
                // initPeopleStatistics(people, thisDay, thisWeek, thisMouth)
            }
        }
    })
}
//人员统计
function initPeopleStatistics() {

    // console.log(thisDay)
    // console.log(thisWeek)
    // console.log(thisMouth)
    peopleStatisticsChart = echarts.init(document.getElementById('peopleStatistics'));
    //   console.log(optionStatisticsChart)
    optionStatisticsChart = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { // 坐标轴指示器，坐标轴触发有效
                type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
            }
        },
        legend: {
            right: 10,
            icon: 'circle',
            data: ['今日', '本周', '本月']
        },
        grid: {
            show: true,
            //   left: '3%',
            right: '4%',
            bottom: '6%',
            containLabel: true,
        },
        dataZoom: [{
                type: 'inside',
                // start: 80,
                // end: 100,
                zoomLock: true //是否锁定选择区域（或叫做数据窗口）的大小。
                    // 如果设置为 true 则锁定选择区域的大小， 也就是说， 只能平移， 不能缩放。
            },
            {
                show: false,
                type: 'slider',
                y: '90%',
                start: 80,
                end: 100,
            }
        ],
        xAxis: [{
            type: 'category',
            //   nameGap: 5,
            //   nameRotate: 45,
            axisLabel: {
                rotate: 45,
                interval: 0
            },
            axisTick: {
                //   show: false
                show: true,
                inside: true
            },
            nameTextStyle: {
                fontSize: 8,
            },
            data: ""
                // data: ['1', '2']
        }],
        yAxis: [{
            type: 'value'
        }],
        series: [{
                name: '今日',
                type: 'bar',
                barWidth: 10,
                itemStyle: {
                    normal: {
                        color: '#50c979',
                        barBorderRadius: 5
                    }
                },
                label: {
                    normal: {
                        show: true,
                        position: 'top',
                        textStyle: {
                            color: "#666",
                            fontSize: 12
                        }
                    }
                },
                // data: ['0', '1']
                data: ""
            },
            {
                name: '本周',
                type: 'bar',
                barWidth: 10,
                itemStyle: {
                    normal: {
                        color: '#f59324',
                        barBorderRadius: 5
                    }
                },
                label: {
                    normal: {
                        show: true,
                        position: 'top',
                        textStyle: {
                            color: "#666",
                            fontSize: 12
                        }
                    }
                },
                // data: ['1', '2']
                data: ""
            },
            {
                name: '本月',
                type: 'bar',
                barWidth: 10,
                itemStyle: {
                    normal: {
                        color: '#fb7760',
                        barBorderRadius: 5
                    }
                },
                label: {
                    normal: {
                        show: true,
                        position: 'top',
                        textStyle: {
                            color: "#666",
                            fontSize: 12
                        }
                    }
                },
                // data: ['2', '1']
                data: ""
            }

        ]
    };
    window.addEventListener("resize", function() {
        peopleStatisticsChart.resize();
    });
    peopleStatisticsChart.setOption(optionStatisticsChart, true);


    // getTaskProcess()
}

$(function() {
    $(".bottom_btn").click(function() {
        if ($mapO.is(":hidden")) {
            $mapO.slideDown();
            $mapBtn.attr("class", "map_up");
        } else {
            $mapO.slideUp();
            $mapBtn.attr("class", "map_down");
        }
    });

});


//放大  ls
function fdshowdatapage() {
    var indexNow = localStorage.getItem("indexNow");
    parent.layer.full(indexNow);
}

//查看数据信息
function showData(id,detectStatus) {
    var rows = $('#tb-all-task').bootstrapTable('getSelections');
    if((id == null || id == "null")){
        if(detectStatus == "未检测" && detectStatus != null){
            parent.layer.confirm('所选桩无检测数据！', {
                btn: ['确定'], //按钮
                skin: 'self'
            });
            return;
        }else if(rows.length == 1 && (rows == []||rows[0].detectStatus== "未检测")){
            parent.layer.confirm('所选桩无检测数据！', {
                btn: ['确定'], //按钮
                skin: 'self'
            });
            return;
        }
    }
    if(id != null){
    } else if (rows.length == 1) {
        var id = rows[0].objectId;
        var detectStatus = rows[0].detectStatus;
        if(detectStatus == "未检测"){
            parent.layer.confirm('所选桩无检测数据！', {
                btn: ['确定'], //按钮
                skin: 'self'
            });
            return;
        }
    } else {
        parent.layer.confirm('请选择一条已检测的测试桩!', {
            btn: ['确定'], //按钮
            skin: 'self'
        });
        return;
    }
    viewData()
    var index = parent.layer.open({
        type: 2, //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title: '检测数据详情',
        area: ['950px', '600px'],
        btn: ['取消'],
        btn2: function(index, layero) {},
        content: content + id
    });
    localStorage.setItem("indexNow", JSON.stringify(index));
}
var content = "";
//查看数据信息
function viewData() {
    if (detectMethod == 1) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m1.html?detectMethod=1&id="
    } else if (detectMethod == 2) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m2.html?detectMethod=2&id="
    } else if (detectMethod == 3) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m3.html?detectMethod=3&id="
    } else if (detectMethod == 4) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m4.html?detectMethod=4&id="
    } else if (detectMethod == 5) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m5.html?detectMethod=5&id="
    } else if (detectMethod == 6) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m6.html?detectMethod=6&id="
    } else if (detectMethod == 8) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m8.html?detectMethod=8&id="
    } else if (detectMethod == 9) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m9.html?detectMethod=9&id="
    } else if (detectMethod == 10) {
        content = getRootPath() + "/../src/html/task/specific_task/view_marker_m10.html?detectMethod=10&id="
    }
}

//驳回重测测试桩

function rejected() {
    var rows = $('#tb-all-task').bootstrapTable('getSelections');
    if (rows.length < 1) {
        parent.layer.confirm('请选择需要重测的测试桩!', {
            btn: ['确定'], //按钮
            skin: 'self'
        });
        return;
    }
    console.log(JSON.stringify(rows))
    var pipelineName = "";
    var markerNumber = ""
    var objectID = "";
    var taskID = "";
    var markerID = ""
    for (var i = 0; i < rows.length; i++) {
        if (rows[i].detectStatus == "未检测") {
            continue;
        }
        if (i != rows.length - 1) {
            objectID += rows[i].objectId + ','
            taskID += rows[i].taskId + ','
            markerID += rows[i].markerId + ','
            markerNumber += rows[i].markerNumber + ",";
            pipelineName += rows[i].pipelineName + ",";
        } else {
            objectID += rows[i].objectId
            taskID += rows[i].taskId
            markerID += rows[i].markerId
            markerNumber += rows[i].markerNumber;
            pipelineName += rows[i].pipelineName;
        }
    }

    if (pipelineName.length == 0) {
        parent.layer.confirm('请选择已完成检测的测试桩!', {
            btn: ['确定'], //按钮
            skin: 'self'
        });
        return
    }
    var index = parent.layer.open({
        type: 2, //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
        title: '重新检测',
        area: ['600px', '550px'],
        btn: ['确认', '取消'],
        maxmin: false,
        yes: function(index, layero) {
            var ab = layero.find('iframe')[0].contentWindow;
            var save = ab.submitData();
            if (save) {
                //刷新曲线图
                if (detectMethod == 2) {
                    $.getScript("../../../js/task/M2/M2graph.js");

                } else if (detectMethod == 1) {
                    $.getScript("../../../js/task/graph.js");
                }
                //刷新测试桩页面数据
                $('#tb-all-task').bootstrapTable('refresh', true);
                parent.layer.close(index);
            }
        },
        btn2: function(index, layero) {},
        end: function(index, layero) {
            parent.layer.close(index);
        },
        content: getRootPath() + "/../src/html/task/specific_task/reject_marker.html?markerNumber=" + encodeURI(markerNumber) + '&pipelineName=' + encodeURI(pipelineName) + '&objectID=' + objectID + '&taskID=' + taskID + '&markerID=' + markerID + '&token=' + token + '&detectMethod=' + detectMethod
    });
}

//审核通过

function approved() {
    var approvedData = "";
    var approvedSuccessMsg = ""
    var hintMsg = ""
    var detectUser = JSON.parse(lsObj.getLocalStorage("userBo")).objectId;
    if ((roleNum == 2 && taskStatus == "执行中") || (detectUser == detectUserId && taskStatus == "执行中")) {
        approvedData = { 'taskId': objectId, 'taskStatus': 3 }
        approvedSuccessMsg = "已提交审核!"
        hintMsg = "提交审核"
    } else if ((roleNum == 2 && taskStatus == "待领取") || (detectUser == detectUserId && taskStatus == "待领取")) {
        approvedData = { 'taskId': objectId, 'taskStatus': 2 }
        approvedSuccessMsg = "已领取任务!"
        hintMsg = "领取任务"
    } else {
        approvedData = { 'taskId': objectId, 'taskStatus': 4 }
        approvedSuccessMsg = "审核通过！"
        hintMsg = "审核通过"
    }
    var flag = false;
    $.ajax({
        url: "/cloudlink-corrosionengineer/task/setTaskStaus?token=" + token,
        dataType: "json",
        type: "post",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify(approvedData),
        async: false,
        success: function(result) {
            if (result.success == 1) {
                try {
                    if (zhugeSwitch == 1) {
                        zhuge.track(hintMsg, { '任务类型': 'M' + detectMethod, "结果": "成功" });
                    }
                } catch (error) {

                }
                parent.layer.confirm(approvedSuccessMsg, {
                    btn: ['确定'], //按钮
                    skin: 'self'
                });
                flag = true;
                // return flag;
            } else {
                try {
                    if (zhugeSwitch == 1) {
                        zhuge.track(hintMsg, { '任务类型': 'M' + detectMethod, "结果": "失败" });
                    }
                } catch (error) {

                }
                parent.layer.confirm(result.msg, {
                    btn: ['确定'], //按钮
                    skin: 'self'
                });
            }
            // flag = false;
            return flag;
        },
        error: function() {
            parent.layer.confirm('审核异常', {
                btn: ['确定'], //按钮
                skin: 'self'
            });
        }

    })
    return flag;
}



//导出测试桩数据
function taskExportWordCheck() {
    var rows = $('#tb-all-task').bootstrapTable('getSelections');
    if (rows.length < 1) {
        parent.layer.confirm('请选择导出测试桩!', {
            btn: ['确定'], //按钮
            skin: 'self'
        });
        return;
    }
    var objectID = "";
    var markNum =""
    var dataId =""
    for (var i = 0; i < rows.length; i++) {
        if (i != rows.length - 1) {
            objectID += rows[i].markerId + ','
            dataId += rows[i].objectId + ','
            markNum += rows[i].markerNumber + ','
        } else {
            objectID += rows[i].markerId
            dataId += rows[i].objectId
            markNum += rows[i].markerNumber
        }
    }
    var url = "/cloudlink-corrosionengineer/task/exportDetectData?token=" + token + '&objectIds=' + objectID + '&type=selected' + '&method=' + detectMethod + '&taskId=' + objectId;
    var urlPic = "/cloudlink-corrosionengineer/task/queryMarkPictures?token=" + token + '&objectId=' + dataId + '&markNum=' + markNum+ '&type=selected';
    $('#exportData').attr("src", url);
    $('#exportPic').attr("src", urlPic);
    uncheck("taskExportWord")
    try {
        if (zhugeSwitch == 1) {
            zhuge.track('导出选中检测数据', { '任务类型': 'M' + detectMethod });
        }
    } catch (error) {

    }
}

//导出全部测试数据
function taskExportWordAll() {
    rowDate = $('#tb-all-task').bootstrapTable('getData');
    if (rowDate.length <= 0) {
        layer.confirm("没有可导出的数据", {
            time: 0, //不自动关闭
            btn: ['确定'],
            skin: 'self'
        });
        return;
    }

    var url = "/cloudlink-corrosionengineer/task/exportDetectData?token=" + token + '&detectResult=' + jsonExportWord.detectResult + '&type=query' + '&method=' + detectMethod + '&startMarkNum=' + jsonExportWord.startMarkNum + '&pipelineId=' + jsonExportWord.pipelineId + '&endMarkNum=' + jsonExportWord.endMarkNum + '&taskId=' + objectId + '&detectStatus=' + jsonExportWord.detectStatus + '&recorder=' +
        jsonExportWord.recorder;
    var urlPic = "/cloudlink-corrosionengineer/task/queryMarkPictures?token=" + token + '&taskId=' + objectId + '&startMarkNum=' + jsonExportWord.startMarkNum + '&pipelineId=' + jsonExportWord.pipelineId + '&endMarkNum=' + jsonExportWord.endMarkNum + '&detectStatus=' + jsonExportWord.detectStatus+  '&recorder=' + jsonExportWord.recorder+ '&detectResult=' + jsonExportWord.detectResult+'&type=query';
    $('#exportData').attr("src", url);
    $('#exportPic').attr("src", urlPic);
    uncheck("taskExportWordAll")
    try {
        if (zhugeSwitch == 1) {
            zhuge.track('导出全部检测数据', { '任务类型': 'M' + detectMethod });
        }
    } catch (error) {

    }
}